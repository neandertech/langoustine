<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"></meta><title>LSP Toolkit</title><link rel="shortcut icon" type="image/x-icon" href="favicon.ico"></link><script type="text/javascript" src="scripts/theme.js"></script><script type="text/javascript" src="scripts/searchData.js" defer="true"></script><script type="text/javascript" src="scripts/scastieConfiguration.js" defer="true"></script><link rel="stylesheet" href="styles/theme/bundle.css"></link><link rel="stylesheet" href="styles/theme/components/bundle.css"></link><link rel="stylesheet" href="styles/theme/components/button/bundle.css"></link><link rel="stylesheet" href="styles/theme/layout/bundle.css"></link><link rel="stylesheet" href="styles/nord-light.css"></link><link rel="stylesheet" href="styles/dotty-icons.css"></link><link rel="stylesheet" href="styles/filter-bar.css"></link><link rel="stylesheet" href="styles/code-snippets.css"></link><link rel="stylesheet" href="styles/searchbar.css"></link><link rel="stylesheet" href="styles/social-links.css"></link><link rel="stylesheet" href="styles/versions-dropdown.css"></link><link rel="stylesheet" href="styles/fontawesome.css"></link><script type="text/javascript" src="hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="scripts/ux.js" defer="true"></script><script type="text/javascript" src="scripts/common/component.js" defer="true"></script><script type="text/javascript" src="scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="scripts/scaladoc-scalajs.js" defer="true"></script><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="https://scastie.scala-lang.org/embedded.js" defer="true"></script><script type="text/javascript" src="scripts/data.js" defer="true"></script><link rel="stylesheet" href="styles/staticsitestyles.css"></link><script>var pathToRoot = "";</script><script>var githubContributorsUrl = "https://api.github.com/repos/neandertech/langoustine";</script><script>var githubContributorsFilename = "docs/_docs/toolkit.md";</script></head><body><div id=""><div id="header" class="body-small"><div class="header-container-left"><a href="" class="logo-container"><span class="project-name h300">Langoustine</span></a><span onclick="dropdownHandler(event)" class="text-button with-arrow" id="dropdown-trigger"><a><div class="projectVersion">0.0.19+3-ff73f83b-SNAPSHOT</div></a></span><div id="version-dropdown" class="dropdown-menu"></div></div><div class="header-container-right"><button id="search-toggle" class="icon-button"></button><span id="theme-toggle" class="icon-button"></span><span id="mobile-menu-toggle" class="icon-button hamburger"></span></div></div><div id="mobile-menu"><div class="mobile-menu-header body-small"><span class="mobile-menu-logo"><span class="project-name h300">Langoustine</span></span><button id="mobile-menu-close" class="icon-button close"></button></div><div class="mobile-menu-container body-medium"><input id="mobile-scaladoc-searchbar-input" class="scaladoc-searchbar-input" type="search" placeholder="Find anything"></input><span id="mobile-theme-toggle" class="mobile-menu-item mode"></span></div></div><span id="mobile-sidebar-toggle" class="floating-button"></span><div id="leftColumn" class="body-small"><div class="switcher-container"><a id="docs-nav-button" class="switcher h100 selected" href="index.html">Docs</a><a id="api-nav-button" class="switcher h100 " href="api/index.html">API</a></div><nav id="docs-nav" class="side-menu"><div class="ni n0 "><span class="nh de"><a href="getting_started.html"><span>Getting started</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="tracer.html"><span>Tracer</span></a></span></div><div class="ni n0 expanded"><span class="nh h100 selected de"><a href="toolkit.html"><span>LSP Toolkit</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="examples.html"><span>Examples</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="CONTRIBUTING.html"><span>Contributing guide</span></a></span></div></nav></div><div id="footer" class="body-small"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/neandertech/langoustine"><button class="icon-button gh"></button></a><div class="text">© 2002-2021 · LAMP/EPFL</div></div><div class="text-mobile">© 2002-2021 · LAMP/EPFL</div></div><div id="scaladoc-searchBar"></div><div id="main"><div class="breadcrumbs container"><a href="index.html">Langoustine</a>/<a href="toolkit.html">LSP Toolkit</a></div><div id="content" class="body-medium"><div><html>
 <head></head>
 <body>
  <section id="lsp-toolkit--testkit"> 
   <h1 class="h500"><a href="#lsp-toolkit--testkit" class="anchor"></a>LSP Toolkit &amp; Testkit</h1> 
   <p>Most LSP servers reach a point where they perform basically the same operations, because of the general nature of them. Things like location map (go from offset to line + character and back efficiently), maintaining a in-memory representation of latest document changes, concurrent state for versioned documents, etc.</p> 
   <p>Eventual goal of Langoustine is to provide performant implementations of whatever common tasks arise. The goal is eventual, as we need to get the protocol and developer experience basics right first, so keep an eye on this page.</p> 
  </section>
  <section id="semantic-tokens-encoder"> 
   <h2 class="h300"><a href="#semantic-tokens-encoder" class="anchor"></a>Semantic tokens encoder</h2> 
   <p>LSP protocol supports <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_semanticTokens">Semantic tokens</a> but their usage comes with a particular encoding that the LSP servers must use.</p> 
   <p>This encoding consists of two parts:</p> 
   <ol> 
    <li> <p>First the server negotiates the semantic tokens "legend" with the client:</p> <p>The legend consists of two arrays where positions are important:</p> 
     <ul> 
      <li><a href="/langoustine/api/langoustine/lsp/enumerations$$SemanticTokenTypes$.html">Token types</a></li> 
      <li><a href="/langoustine/api/langoustine/lsp/enumerations$$SemanticTokenModifiers$.html#">Token modifiers</a></li> 
     </ul> <p>The positions in those arrays are important - their numeric indices will be used in the encoding of semantic tokens for a document.</p> </li> 
    <li> <p>Then, the server requests the semantic tokens for a particular document.</p> <p>Encoding this result naively can lead to gigantic payloads passed back and forth between client and server.</p> <p>To avoid that, a sort of delta encoding is used:</p> 
     <ul> 
      <li> <p>line numbers and character offsets are recorded as deltas from the token previous in the list</p> </li> 
      <li> <p>token types are encoded as integer indices, refering to the location of the token in the array negotiated as part of the (1)</p> </li> 
      <li> <p>token modifiers are encoded as a single integer, with bit number <code>N</code> set to <code>1</code> if the current token has a modifier with position <code>N</code> in the array negotiated as part of (1)</p> </li> 
     </ul> </li> 
   </ol> 
   <p>This encoding is the only one you can use semantic tokens in the current version of LSP specification.</p> 
   <p>To that end, Langoustine provides a utility that will encode the tokens for you. Enter <a href="/langoustine/api/langoustine/lsp/tools/SemanticTokensEncoder.html">SemanticTokensEncoder</a>.</p> 
   <div class="snippet mono-small-block" scala-snippet="" runnable="">
    <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>import langoustine.lsp.tools.*
</span><span line-number="2" class=""><span class="tooltip-container"></span>import langoustine.lsp.all.*
</span><span line-number="3" class=""><span class="tooltip-container"></span>
</span><span line-number="4" class=""><span class="tooltip-container"></span>val encoder = SemanticTokensEncoder(
</span><span line-number="5" class=""><span class="tooltip-container"></span>    tokenTypes = Vector(SemanticTokenTypes.variable, SemanticTokenTypes.`class`),
</span><span line-number="6" class=""><span class="tooltip-container"></span>    modifiers = Vector(SemanticTokenModifiers.definition, SemanticTokenModifiers.static)
</span><span line-number="7" class=""><span class="tooltip-container"></span>)
</span></code></pre>
    <div class="buttons"></div>
   </div> 
   <p>Using that <code>encoder</code>, you can produce the <code>SemanticTokensLegend</code> required as as part of the server capabilities response:</p> 
   <div class="snippet mono-small-block" scala-snippet="">
    <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>ServerCapabilities(
</span><span line-number="2" class=""><span class="tooltip-container"></span>  //...
</span><span line-number="3" class=""><span class="tooltip-container"></span>  semanticTokensProvider = Opt(
</span><span line-number="4" class=""><span class="tooltip-container"></span>    SemanticTokensOptions(
</span><span line-number="5" class=""><span class="tooltip-container"></span>      legend = encoder.legend,
</span><span line-number="6" class=""><span class="tooltip-container"></span>      full = Opt(true)
</span><span line-number="7" class=""><span class="tooltip-container"></span>    )
</span><span line-number="8" class=""><span class="tooltip-container"></span>  ),
</span><span line-number="9" class=""><span class="tooltip-container"></span>  //...
</span><span line-number="10" class=""><span class="tooltip-container"></span>)
</span></code></pre>
    <div class="buttons"></div>
   </div> 
   <p>And encode the tokens directly into a <code>SemanticTokens</code>:</p> 
   <div class="snippet mono-small-block" scala-snippet="" runnable="">
    <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>import langoustine.lsp.tools.*
</span><span line-number="2" class=""><span class="tooltip-container"></span>import langoustine.lsp.all.*
</span><span line-number="3" class=""><span class="tooltip-container"></span>
</span><span line-number="4" class=""><span class="tooltip-container"></span>val encoder = SemanticTokensEncoder(
</span><span line-number="5" class=""><span class="tooltip-container"></span>  tokenTypes = Vector(SemanticTokenTypes.variable, SemanticTokenTypes.`class`),
</span><span line-number="6" class=""><span class="tooltip-container"></span>  modifiers = Vector(SemanticTokenModifiers.definition, SemanticTokenModifiers.static)
</span><span line-number="7" class=""><span class="tooltip-container"></span>)
</span><span line-number="8" class=""><span class="tooltip-container"></span>
</span><span line-number="9" class=""><span class="tooltip-container"></span>val payload: Either[SemanticTokensEncoder.Error, SemanticTokens] = 
</span><span line-number="10" class=""><span class="tooltip-container"></span>  encoder.encode(
</span><span line-number="11" class=""><span class="tooltip-container"></span>    Vector(
</span><span line-number="12" class=""><span class="tooltip-container"></span>        SemanticToken.fromRange(
</span><span line-number="13" class=""><span class="tooltip-container"></span>            Range(Position(0, 0), Position(0, 5)),
</span><span line-number="14" class=""><span class="tooltip-container"></span>            SemanticTokenTypes.variable
</span><span line-number="15" class=""><span class="tooltip-container"></span>        ),
</span><span line-number="16" class=""><span class="tooltip-container"></span>        SemanticToken.fromRange(
</span><span line-number="17" class=""><span class="tooltip-container"></span>            Range(Position(3, 25), Position(3, 27)),
</span><span line-number="18" class=""><span class="tooltip-container"></span>            SemanticTokenTypes.`class`
</span><span line-number="19" class=""><span class="tooltip-container"></span>        )
</span><span line-number="20" class=""><span class="tooltip-container"></span>    )
</span><span line-number="21" class=""><span class="tooltip-container"></span>  )
</span><span line-number="22" class=""><span class="tooltip-container"></span>
</span><span line-number="23" class=""><span class="tooltip-container"></span>assert(payload.map(_.data) == Right(Vector(0, 0, 5, 0, 0, 3, 25, 2, 1, 0)))
</span></code></pre>
    <div class="buttons"></div>
   </div> 
   <p>The <code>encode</code> method returns <code>Left(...)</code> in case you used a token type or modifier that this encoder wasn't created to handle.</p> 
   <p>One current limitation is that there is no facility to produce a delta response - which is basically a list of edits from one array to another.</p> 
  </section> 
 </body>
</html></div><div id="toc" class="body-small"><div id="toc-container"><span class="toc-title h200">In this article</span><nav class="toc-nav"><ul class="toc-list"><li><a href="#lsp-toolkit--testkit">LSP Toolkit &amp; Testkit</a><ul><li><a href="#semantic-tokens-encoder">Semantic tokens encoder</a></li></ul></li></ul></nav></div></div></div><div id="footer" class="body-small mobile-footer"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/lampepfl/dotty"><button class="icon-button gh"></button></a><a href="https://twitter.com/scala_lang"><button class="icon-button twitter"></button></a><a href="https://discord.com/invite/scala"><button class="icon-button discord"></button></a><a href="https://gitter.im/scala/scala"><button class="icon-button gitter"></button></a><div class="text">© 2002-2021 · LAMP/EPFL</div></div><div class="text-mobile">© 2002-2021 · LAMP/EPFL</div></div></div></div></body></html>